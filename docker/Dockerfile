#!/bin/bash
set -euo pipefail

# ä¾èµ–æ£€æŸ¥æ¸…å•
REQUIRED_DEPS=("wget" "tar" "xz" "install")
for dep in "${REQUIRED_DEPS[@]}"; do
    if ! command -v $dep &>/dev/null; then
        echo "âŒ ç¼ºå°‘ä¾èµ–: $dep"
        exit 3
    fi
done

# æ¶æ„æ˜ å°„
TARGET_ARCH=${1:-amd64}
case "$TARGET_ARCH" in
    amd64) PKG="amd64" ;;
    arm64) PKG="arm64" ;;
    *)     echo "âŒ ä¸æ”¯æŒçš„æ¶æ„: $TARGET_ARCH"; exit 1 ;;
esac

# å¸¦MD5æ ¡éªŒçš„ä¸‹è½½
FFMPEG_URL="https://johnvansickle.com/ffmpeg/builds/ffmpeg-git-${PKG}-static.tar.xz"
MD5_URL="${FFMPEG_URL}.md5"
echo "ğŸ” éªŒè¯æ–‡ä»¶å®Œæ•´æ€§..."
wget -q "$MD5_URL" -O expected.md5

RETRY_COUNT=3
for ((i=1; i<=RETRY_COUNT; i++)); do
    echo "ğŸ”„ ä¸‹è½½å°è¯• $i/$RETRY_COUNT"
    if wget -q --tries=3 --timeout=30 "$FFMPEG_URL" -O ffmpeg.tar.xz; then
        # MD5æ ¡éªŒ
        if md5sum -c expected.md5; then
            break
        else
            echo "âŒ MD5æ ¡éªŒå¤±è´¥ï¼Œé‡æ–°ä¸‹è½½..."
            rm -f ffmpeg.tar.xz
        fi
    fi
    sleep $((i*2))
done

# è§£å‹æµç¨‹
EXTRACT_DIR=$(tar -tf ffmpeg.tar.xz | head -1 | cut -d '/' -f1)
echo "ğŸ“‚ è§£å‹åˆ°ç›®å½•: $EXTRACT_DIR"
tar -xf ffmpeg.tar.xz || { echo "âŒ è§£å‹å¤±è´¥"; exit 4; }

# å®‰è£…éªŒè¯
install -v -m 755 "$EXTRACT_DIR/ffmpeg" /usr/local/bin/
if ! ffmpeg -version &>/dev/null; then
    echo "âŒ FFmpegå®‰è£…éªŒè¯å¤±è´¥"
    exit 5
fi

# æ¸…ç†
rm -rf ffmpeg.tar.xz expected.md5 "$EXTRACT_DIR"
echo "âœ… FFmpegå®‰è£…æˆåŠŸ"